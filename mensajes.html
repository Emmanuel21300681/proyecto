<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mensajes - AthleticXs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap");

    body {
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: #f5f5f5;
    }

    .container-fluid {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 300px;
      background: white;
      border-right: 1px solid #ddd;
      padding: 15px;
      overflow-y: auto;
    }

    .chat-list-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.3s;
    }

    .chat-list-item:hover {
      background: #f0f0f0;
    }

    .chat-list-item img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #e5ddd5;
    }

    .chat-header {
      background: #075e54;
      color: white;
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: url('https://path-to-whatsapp-bg.jpg') repeat;
    }

    .message {
      max-width: 60%;
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 10px;
      position: relative;
    }

    .message.sent {
      background: #dcf8c6;
      margin-left: auto;
      text-align: right;
    }

    .message.received {
      background: white;
      margin-right: auto;
    }

    .message img {
      max-width: 100%;
      border-radius: 10px;
    }

    .message-timestamp {
      font-size: 10px;
      color: #777;
      margin-top: 5px;
    }

    .chat-input {
      display: flex;
      padding: 15px;
      background: white;
      border-top: 1px solid #ddd;
      align-items: center;
    }

    .chat-input input[type="text"] {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 20px;
      margin-right: 10px;
    }

    .chat-input button, .chat-input label {
      background: #075e54;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      margin-left: 5px;
    }

    .chat-input input[type="file"] {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <!-- Barra lateral con lista de chats -->
    <div class="sidebar">
      <h5>Mensajes</h5>
      <div id="chat-list"></div>
    </div>

    <!-- Área de chat -->
    <div class="chat-area" id="chat-area" style="display: none;">
      <div class="chat-header">
        <div style="display: flex; align-items: center;">
          <img id="chat-user-img" src="" alt="User">
          <h5 id="chat-user-name"></h5>
        </div>
      </div>
      <div class="chat-messages" id="chat-messages"></div>
      <div class="chat-input">
        <input type="text" id="message-input" placeholder="Escribe un mensaje...">
        <label for="image-upload"><i class="fas fa-paperclip"></i></label>
        <input type="file" id="image-upload" accept="image/*">
        <button id="send-message"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <!-- Incluir Firebase y Socket.IO desde CDN -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js"></script>
  <script>
    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCqL19JlWeUzDk6QVPeuYGp3cdHQVlB4zI",
      authDomain: "athleticxs-7af6a.firebaseapp.com",
      projectId: "athleticxs-7af6a",
      storageBucket: "athleticxs-7af6a.firebasestorage.app",
      messagingSenderId: "799871479390",
      appId: "1:799871479390:web:05583a4e041d1bd0298ecf",
      measurementId: "G-3CBDN0CB2W"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Código del chat
    const socket = io('http://localhost:5000');
    const userEmail = localStorage.getItem('email');
    let currentChatId = null;
    let currentUserId = null;

    // Cargar lista de chats
    async function loadChatList() {
      const response = await fetch(`http://localhost:5000/api/chats/${userEmail}`);
      const data = await response.json();
      const chatList = document.getElementById('chat-list');
      chatList.innerHTML = '';

      if (data.success && data.chats.length > 0) {
        data.chats.forEach(chat => {
          const otherUser = chat.participants.find(p => p !== userEmail);
          chatList.innerHTML += `
            <div class="chat-list-item" data-chat-id="${chat.id}" data-user-id="${otherUser}">
              <img src="default-profile.jpg" alt="User">
              <div>
                <strong>${otherUser}</strong>
                <p>Último mensaje...</p>
              </div>
            </div>
          `;
        });

        // Añadir eventos a los elementos de la lista
        document.querySelectorAll('.chat-list-item').forEach(item => {
          item.addEventListener('click', () => openChat(item.dataset.chatId, item.dataset.userId));
        });
      } else {
        chatList.innerHTML = '<p>No tienes chats aún.</p>';
      }
    }

    // Abrir un chat
    function openChat(chatId, userId) {
      currentChatId = chatId;
      currentUserId = userId;
      document.getElementById('chat-area').style.display = 'flex';
      document.getElementById('chat-user-name').textContent = userId;
      document.getElementById('chat-user-img').src = 'default-profile.jpg';

      // Cargar mensajes
      const messagesRef = db.collection(`chats/${chatId}/messages`).orderBy('timestamp', 'asc');
      messagesRef.onSnapshot(snapshot => {
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.innerHTML = '';
        snapshot.forEach(doc => {
          const msg = doc.data();
          const isSent = msg.sender === userEmail;
          chatMessages.innerHTML += `
            <div class="message ${isSent ? 'sent' : 'received'}">
              ${msg.type === 'image' ? `<img src="${msg.imageUrl}" alt="Image">` : msg.content}
              <div class="message-timestamp">${new Date(msg.timestamp).toLocaleTimeString()}</div>
            </div>
          `;
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });

      socket.emit('joinChat', chatId);
    }

    // Enviar mensaje
    document.getElementById('send-message').addEventListener('click', async () => {
      const content = document.getElementById('message-input').value.trim();
      if (content && currentChatId) {
        socket.emit('sendMessage', {
          chatId: currentChatId,
          senderId: userEmail,
          content,
          type: 'text',
        });
        document.getElementById('message-input').value = '';
      }
    });

    // Enviar imagen
    document.getElementById('image-upload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file && currentChatId) {
        const storageRef = storage.ref(`chat_images/${Date.now()}_${file.name}`);
        await storageRef.put(file);
        const imageUrl = await storageRef.getDownloadURL();
        socket.emit('sendMessage', {
          chatId: currentChatId,
          senderId: userEmail,
          imageUrl,
          type: 'image',
        });
      }
    });

    // Escuchar mensajes nuevos
    socket.on('newMessage', (message) => {
      const chatMessages = document.getElementById('chat-messages');
      const isSent = message.sender === userEmail;
      chatMessages.innerHTML += `
        <div class="message ${isSent ? 'sent' : 'received'}">
          ${message.type === 'image' ? `<img src="${message.imageUrl}" alt="Image">` : message.content}
          <div class="message-timestamp">${new Date(message.timestamp).toLocaleTimeString()}</div>
        </div>
      `;
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    // Cargar lista de chats al iniciar
    loadChatList();
  </script>
</body>
</html>